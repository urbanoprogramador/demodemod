<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocketServer</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            /* O cualquier otro color de fondo que prefieras */
            margin: 0;
        }
    </style>
</head>

<body>

    <script src="socket.io/socket.io.js"></script>

    <script>
        var socket = io();

        socket.on('connect', function () {
            console.log('Conectado al servidor')
        });

        socket.on('disconnect', function () {
            console.log('Perdimos comunicación con el servidor');
        });

        

    </script>
    <div>
        <h1 id="ganador"></h1>
        <div id="votos"></div>
        <canvas id="canvas" width="400" height="500" style="border: solid 1px;"></canvas>
    </div>
    


    <script>
        const usuarios = document.getElementById('usuarios');
        socket.on('usuarios', function (p) {
            usuarios.innerHTML = '';
            p.forEach(element => {
                usuarios.innerHTML += `<div>${element.nombre}</div>`;
            });
        });
        const canvas = document.getElementById('canvas');

        const hombre = new Image();
        hombre.src = '/img/m-play.png';
        const mujer = new Image();
        mujer.src = '/img/f-play.png';
        const neutro = new Image();
        neutro.src = '/img/n-play.png';
        const ctx = canvas.getContext('2d');
        let ganador = false;
        const m = new Image();
        m.src = '/img/m.png';
        socket.on('bebes', function (p) {
            if(ganador){
                return;
            }
            // Limpia el canvas antes de dibujar los nuevos bebés
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            canvas.width = 500;
            canvas.height = 500;

            p.forEach((element, index) => {

                // Calcula las posiciones x y y basadas en el índice para evitar la sobreposición
                var x = 50 * element.x;
                var y = element.y * 50;

                if (element.gender === 1)
                    ctx.drawImage(hombre, x, y, 50, 50);
                if (element.gender === 0)
                    ctx.drawImage(mujer, x, y, 50, 50);
                if (element.gender === 2)
                    ctx.drawImage(neutro, x, y, 50, 50);
            });
        });

        const voto = document.getElementById('votos');
        socket.emit('getUsers');
        socket.on('ganador', function (payload) {
            ganador = true;
            document.getElementById('ganador').innerHTML = `El ganador es: ${payload.alias}`;
            setTimeout(() => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(m, 150, 150, 250, 250);
                
            }, 10000);
            
        });
        socket.on('newUser', function (payload) {
            console.log('Escuhando:', payload);
            let hombre = 0;
            let mujer = 0;
            payload.forEach(element => {
                if(element.gender === 0){
                    hombre++;
                }
                if(element.gender === 1){
                    mujer++;
                }
            });
            document.getElementById('votos').innerHTML = `<div>Hombres: ${hombre}</div>
            <div>Mujeres: ${mujer}</div>`;
        });
    </script>

</body>

</html>